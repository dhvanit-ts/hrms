generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url = env("DATABASE_URL")
  relationMode = "prisma"
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String
  entity      String
  entityId    String
  performedBy Int?
  timestamp   DateTime @default(now())
  metadata    Json?

  @@map("audit_logs")
}

model Attendance {
  id         Int       @id @default(autoincrement())
  employeeId Int
  shiftId    Int?
  date       DateTime
  checkIn    DateTime?
  checkOut   DateTime?
  duration   Int?
  type       String?
  ipAddress  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  employee   Employee  @relation(fields: [employeeId], references: [id])
  shift      Shift?    @relation(fields: [shiftId], references: [id])
  breaks     Break[]
  tickets    Ticket[]

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([shiftId])
}

model Break {
  id           Int       @id @default(autoincrement())
  attendanceId Int
  startTime    DateTime
  endTime      DateTime?
  duration     Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
}

model Department {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  managerId Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  manager   Employee? @relation("DepartmentManager",fields: [managerId],references: [id],onDelete: NoAction,onUpdate: NoAction)

  employees Employee[]

  @@index([managerId])
}

model Employee {
  id                 Int             @id @default(autoincrement())
  employeeId         String          @unique
  name               String
  email              String          @unique
  passwordHash       String?
  phone              String?
  dateOfBirth        DateTime?
  departmentId       Int?
  jobRoleId          Int?
  shiftId            Int?
  hireDate           DateTime?
  terminationDate    DateTime?
  status             EmployeeStatus  @default(active)
  salary             Int             @default(0)
  leaveAllowance     Int             @default(10)
  lastLogin          DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

department Department? @relation(fields: [departmentId], references: [id])
  managedDepartments Department[] @relation("DepartmentManager")
  jobRole            JobRole?        @relation(fields: [jobRoleId], references: [id])
  shift              Shift?          @relation(fields: [shiftId], references: [id])

  payrolls           Payroll[]
  attendances        Attendance[]
  leaveRequests      LeaveRequest[]  @relation("EmployeeLeaveRequests")
  approvals          LeaveRequest[]  @relation("EmployeeApprovals")
  refreshTokens      EmployeeRefreshToken[]
  bankDetails        BankDetails?
  tickets            Ticket[]
  ticketApprovals    Ticket[]        @relation("TicketApprovals")

  @@index([departmentId])
  @@index([jobRoleId])
  @@index([shiftId])
}

model JobRole {
  id          Int       @id @default(autoincrement())
  title       String
  level       Int
  permissions Json  @default("[]")
  isActive    Boolean @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employees Employee[]
}

model LeaveRequest {
  id         Int         @id @default(autoincrement())
  employeeId Int
  type       String
  startDate  DateTime
  endDate    DateTime
  status     LeaveStatus @default(pending)
  approverId Int?
  reason     String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  employee Employee  @relation("EmployeeLeaveRequests", fields: [employeeId], references: [id])
  approver Employee? @relation("EmployeeApprovals", fields: [approverId], references: [id])

  @@index([employeeId])
  @@index([approverId])
}

model Payroll {
  id         Int      @id @default(autoincrement())
  employeeId Int
  salary     Decimal  @db.Decimal(10,2)
  allowances Decimal? @db.Decimal(10,2)
  deductions Decimal? @db.Decimal(10,2)
  payDate    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model User {
  id           Int            @id @default(autoincrement())
  email        String         @unique
  passwordHash String
  roles        Json           @default("[]")
  isActive     Boolean        @default(true)
  lastLogin    DateTime?
  profileRef   Int?           @unique
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  profile       Profile?        @relation(fields: [profileRef], references: [id])
  refreshTokens RefreshToken[]
  leads         Lead[]
  leadActivities LeadActivity[]

  @@index([email])
  @@index([isActive])
}

model Profile {
  id Int @id @default(autoincrement())

  user User?
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  jti       String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  userId    Int

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model EmployeeRefreshToken {
  id         Int       @id @default(autoincrement())
  jti        String    @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  employeeId Int

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model BankDetails {
  id            Int      @id @default(autoincrement())
  employeeId    Int      @unique
  accountNumber String
  bankName      String
  branchName    String?
  ifscCode      String
  accountType   String   @default("savings")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

model Shift {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  startTime   String   // Format: "HH:MM" (e.g., "09:00")
  endTime     String   // Format: "HH:MM" (e.g., "17:00")
  breakTime   Int      @default(60) // Break time in minutes
  isActive    Boolean  @default(true)
  description String?
  isDefault   Boolean? @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  employees   Employee[]
  attendances Attendance[]

  @@index([isActive])
}

model Holiday {
  id          Int      @id @default(autoincrement())
  name        String
  date        DateTime
  description String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, name])
  @@index([date])
}

model Lead {
  id          Int        @id @default(autoincrement())
  name        String
  email       String
  phone       String?
  company     String?
  position    String?
  source      String?    // e.g., "website", "referral", "cold_call"
  status      LeadStatus @default(new)
  priority    Priority   @default(medium)
  assignedTo  Int?       // Manager who owns this lead
  notes       String?    @db.Text
  value       Decimal?   @db.Decimal(10,2) // Potential deal value
  followUpDate DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  manager     User?      @relation(fields: [assignedTo], references: [id])
  activities  LeadActivity[]

  @@index([assignedTo])
  @@index([status])
  @@index([followUpDate])
}

model LeadActivity {
  id          Int            @id @default(autoincrement())
  leadId      Int
  type        ActivityType
  description String         @db.Text
  performedBy Int
  createdAt   DateTime       @default(now())

  lead        Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [performedBy], references: [id])

  @@index([leadId])
  @@index([performedBy])
}

enum AppRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum LeaveStatus {
  pending
  approved
  rejected
}

enum EmployeeStatus {
  active
  inactive
  terminated
}

enum LeadStatus {
  new
  contacted
  qualified
  proposal
  negotiation
  closed_won
  closed_lost
}

enum Priority {
  low
  medium
  high
  urgent
}

enum ActivityType {
  call
  email
  meeting
  note
  task
}

model Event {
  id         Int      @id @default(autoincrement())
  type       String   // "LEAVE_REQUESTED", "LEAVE_APPROVED", etc.
  actorId    Int?     // Who performed the action
  targetId   String   // ID of the target entity
  targetType String   // "leave_request", "employee", etc.
  metadata   Json?    // Additional context data
  createdAt  DateTime @default(now())

  @@index([type])
  @@index([createdAt])
  @@map("events")
}

model Notification {
  id             Int      @id @default(autoincrement())
  receiverId     Int      // Employee or User who should receive this
  receiverType   String   // "employee" or "user"
  type           String   // Same as event type
  targetId       String
  targetType     String
  
  actors         Json     @default("[]") // Array of actor names/IDs
  count          Int      @default(1)    // Number of bundled events
  
  state          NotificationState @default(unread)
  aggregationKey String   @unique // Key for bundling similar notifications
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deliveredAt    DateTime?
  seenAt         DateTime?

  @@unique([receiverId, receiverType, aggregationKey])
  @@index([receiverId, receiverType])
  @@index([state])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationState {
  unread
  delivered
  seen
}

model Ticket {
  id           Int          @id @default(autoincrement())
  ticketNumber String       @unique // Auto-generated: TKT-001, TKT-002, etc.
  employeeId   Int
  type         TicketType
  category     TicketCategory
  title        String
  description  String       @db.Text
  priority     Priority     @default(medium)
  status       TicketStatus @default(pending)
  approverId   Int?
  approverNotes String?     @db.Text
  
  // Attendance correction specific fields
  attendanceId     Int?
  requestedDate    DateTime?
  requestedCheckIn DateTime?
  requestedCheckOut DateTime?
  
  // Leave request specific fields (for extra leave)
  leaveType        String?
  leaveStartDate   DateTime?
  leaveEndDate     DateTime?
  leaveDays        Int?
  
  // Profile change specific fields
  profileChanges   Json?    // Store field changes as JSON
  
  // Metadata
  metadata     Json?
  attachments  Json?        @default("[]") // Array of file URLs/paths
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  approvedAt   DateTime?
  rejectedAt   DateTime?

  employee     Employee     @relation(fields: [employeeId], references: [id])
  approver     Employee?    @relation("TicketApprovals", fields: [approverId], references: [id])
  attendance   Attendance?  @relation(fields: [attendanceId], references: [id])
  comments     TicketComment[]

  @@index([employeeId])
  @@index([approverId])
  @@index([attendanceId])
  @@index([status])
  @@index([type])
  @@index([category])
  @@index([createdAt])
}

model TicketComment {
  id        Int      @id @default(autoincrement())
  ticketId  Int
  authorId  Int
  authorType String  // "employee" or "user" (for admin/manager)
  content   String   @db.Text
  isInternal Boolean @default(false) // Internal notes only visible to approvers
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId, authorType])
  @@index([createdAt])
}

enum TicketType {
  attendance_correction
  extra_leave_request
  profile_change_request
}

enum TicketCategory {
  // Attendance categories
  late_checkin
  early_checkout
  missing_checkin
  missing_checkout
  wrong_attendance_type
  
  // Leave categories
  emergency_leave
  extended_leave
  unpaid_leave
  
  // Profile change categories
  personal_info
  employment_details
  shift_change
  department_transfer
  job_role_change
  salary_adjustment
  contact_details
}

enum TicketStatus {
  pending
  under_review
  approved
  rejected
  cancelled
}
