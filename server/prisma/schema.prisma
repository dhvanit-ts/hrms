generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url = env("DATABASE_URL")
  relationMode = "prisma"
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String
  entity      String
  entityId    String
  performedBy Int?
  timestamp   DateTime @default(now())
  metadata    Json?

  @@map("audit_logs")
}

model Attendance {
  id         Int       @id @default(autoincrement())
  employeeId Int
  shiftId    Int?
  date       DateTime
  checkIn    DateTime?
  checkOut   DateTime?
  duration   Int?
  type       String?
  ipAddress  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  employee   Employee  @relation(fields: [employeeId], references: [id])
  shift      Shift?    @relation(fields: [shiftId], references: [id])
  breaks     Break[]

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@index([shiftId])
}

model Break {
  id           Int       @id @default(autoincrement())
  attendanceId Int
  startTime    DateTime
  endTime      DateTime?
  duration     Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  attendance   Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
}

model Department {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  managerId Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  manager   Employee? @relation("DepartmentManager",fields: [managerId],references: [id],onDelete: NoAction,onUpdate: NoAction)

  employees Employee[]

  @@index([managerId])
}

model Employee {
  id                 Int             @id @default(autoincrement())
  employeeId         String          @unique
  name               String
  email              String          @unique
  passwordHash       String?
  phone              String?
  dateOfBirth        DateTime?
  departmentId       Int?
  jobRoleId          Int?
  shiftId            Int?
  hireDate           DateTime?
  terminationDate    DateTime?
  status             EmployeeStatus  @default(active)
  salary             Int             @default(0)
  leaveAllowance     Int             @default(10)
  lastLogin          DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

department Department? @relation(fields: [departmentId], references: [id])
  managedDepartments Department[] @relation("DepartmentManager")
  jobRole            JobRole?        @relation(fields: [jobRoleId], references: [id])
  shift              Shift?          @relation(fields: [shiftId], references: [id])

  payrolls           Payroll[]
  attendances        Attendance[]
  leaveRequests      LeaveRequest[]  @relation("EmployeeLeaveRequests")
  approvals          LeaveRequest[]  @relation("EmployeeApprovals")
  refreshTokens      EmployeeRefreshToken[]
  bankDetails        BankDetails?

  @@index([departmentId])
  @@index([jobRoleId])
  @@index([shiftId])
}

model JobRole {
  id          Int       @id @default(autoincrement())
  title       String
  level       Int
  permissions Json  @default("[]")
  isActive    Boolean @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  employees Employee[]
}

model LeaveRequest {
  id         Int         @id @default(autoincrement())
  employeeId Int
  type       String
  startDate  DateTime
  endDate    DateTime
  status     LeaveStatus @default(pending)
  approverId Int?
  reason     String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  employee Employee  @relation("EmployeeLeaveRequests", fields: [employeeId], references: [id])
  approver Employee? @relation("EmployeeApprovals", fields: [approverId], references: [id])

  @@index([employeeId])
  @@index([approverId])
}

model Payroll {
  id         Int      @id @default(autoincrement())
  employeeId Int
  salary     Decimal  @db.Decimal(10,2)
  allowances Decimal? @db.Decimal(10,2)
  deductions Decimal? @db.Decimal(10,2)
  payDate    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model User {
  id           Int            @id @default(autoincrement())
  email        String         @unique
  passwordHash String
  roles        Json           @default("[]")
  isActive     Boolean        @default(true)
  lastLogin    DateTime?
  profileRef   Int?           @unique
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  profile       Profile?        @relation(fields: [profileRef], references: [id])
  refreshTokens RefreshToken[]
  leads         Lead[]
  leadActivities LeadActivity[]

  @@index([email])
  @@index([isActive])
}

model Profile {
  id Int @id @default(autoincrement())

  user User?
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  jti       String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  userId    Int

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model EmployeeRefreshToken {
  id         Int       @id @default(autoincrement())
  jti        String    @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  employeeId Int

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model BankDetails {
  id            Int      @id @default(autoincrement())
  employeeId    Int      @unique
  accountNumber String
  bankName      String
  branchName    String?
  ifscCode      String
  accountType   String   @default("savings")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
}

model Shift {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  startTime   String   // Format: "HH:MM" (e.g., "09:00")
  endTime     String   // Format: "HH:MM" (e.g., "17:00")
  breakTime   Int      @default(60) // Break time in minutes
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  employees   Employee[]
  attendances Attendance[]

  @@index([isActive])
}

model Holiday {
  id          Int      @id @default(autoincrement())
  name        String
  date        DateTime
  description String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, name])
  @@index([date])
}

model Lead {
  id          Int        @id @default(autoincrement())
  name        String
  email       String
  phone       String?
  company     String?
  position    String?
  source      String?    // e.g., "website", "referral", "cold_call"
  status      LeadStatus @default(new)
  priority    Priority   @default(medium)
  assignedTo  Int?       // Manager who owns this lead
  notes       String?    @db.Text
  value       Decimal?   @db.Decimal(10,2) // Potential deal value
  followUpDate DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  manager     User?      @relation(fields: [assignedTo], references: [id])
  activities  LeadActivity[]

  @@index([assignedTo])
  @@index([status])
  @@index([followUpDate])
}

model LeadActivity {
  id          Int            @id @default(autoincrement())
  leadId      Int
  type        ActivityType
  description String         @db.Text
  performedBy Int
  createdAt   DateTime       @default(now())

  lead        Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [performedBy], references: [id])

  @@index([leadId])
  @@index([performedBy])
}

enum AppRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum LeaveStatus {
  pending
  approved
  rejected
}

enum EmployeeStatus {
  active
  inactive
  terminated
}

enum LeadStatus {
  new
  contacted
  qualified
  proposal
  negotiation
  closed_won
  closed_lost
}

enum Priority {
  low
  medium
  high
  urgent
}

enum ActivityType {
  call
  email
  meeting
  note
  task
}
